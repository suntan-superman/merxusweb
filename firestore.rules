rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user belongs to restaurant
    function belongsToRestaurant(restaurantId) {
      return isAuthenticated() && 
             request.auth.token.restaurantId == restaurantId;
    }
    
    // Helper function to check if user is owner
    function isOwner(restaurantId) {
      return belongsToRestaurant(restaurantId) && 
             request.auth.token.role == 'owner';
    }
    
    // Helper function to check if user is owner or manager
    function isOwnerOrManager(restaurantId) {
      return belongsToRestaurant(restaurantId) && 
             (request.auth.token.role == 'owner' || 
              request.auth.token.role == 'manager');
    }
    
    // Helper function to check if user is Merxus admin
    function isMerxusAdmin() {
      return isAuthenticated() && 
             (request.auth.token.role == 'merxus_admin' || 
              request.auth.token.role == 'merxus_support');
    }
    
    // Restaurant data - ALL subcollections under a restaurant
    // Uses recursive wildcard to match any depth
    match /restaurants/{restaurantId}/{document=**} {
      // Restaurant users can read/write their own data
      allow read, write: if belongsToRestaurant(restaurantId);
      // Merxus admins can read/write all restaurant data
      allow read, write: if isMerxusAdmin();
    }
    
    // Merxus admin collections
    match /merxus/{document=**} {
      allow read, write: if isMerxusAdmin();
    }
    
    // Call sessions - backend writes, restaurant users can read their calls
    match /callSessions/{callId} {
      allow read: if isAuthenticated() && 
                    resource.data.restaurantId == request.auth.token.restaurantId;
      allow write: if false; // Only backend can write
    }
  }
}

